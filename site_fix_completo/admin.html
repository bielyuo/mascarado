<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <title>Admin ‚Äî M√°scara Secreta</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--red:#c0152a;--red-glow:#ff2244;--dark:#080c10;--navy:#0d1520;--silver:#a8b8cc;--white:#eef2f7;--sidebar:#0a1628;--green:#1db954}
    html,body{height:100%}
    body{background:var(--dark);font-family:'Rajdhani',sans-serif;color:var(--white);display:flex;flex-direction:column}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--dark)}::-webkit-scrollbar-thumb{background:var(--red);border-radius:3px}

    /* TOPBAR */
    .topbar{background:linear-gradient(90deg,var(--red),#8a0f1e);height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;flex-shrink:0;box-shadow:0 2px 12px rgba(0,0,0,.5)}
    .topbar-logo{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:900;letter-spacing:.15em;color:#fff}
    .topbar-right{display:flex;align-items:center;gap:1.5rem}
    .topbar-link{font-size:.8rem;color:rgba(255,255,255,.85);text-decoration:none;transition:color .2s}
    .topbar-link:hover{color:#fff}

    /* LAYOUT */
    .layout{display:flex;flex:1;overflow:hidden}

    /* SIDEBAR */
    .sidebar{width:200px;flex-shrink:0;background:var(--sidebar);border-right:1px solid rgba(192,21,42,.25);display:flex;flex-direction:column;overflow-y:auto}
    .sidebar-section{padding:.5rem 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .sidebar-title{font-size:.65rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(168,184,204,.4);padding:.75rem 1rem .4rem;font-weight:700}
    .sidebar-item{display:flex;align-items:center;gap:10px;padding:.65rem 1rem;cursor:pointer;font-size:.88rem;font-weight:600;letter-spacing:.05em;color:var(--silver);transition:all .2s;border-left:3px solid transparent}
    .sidebar-item:hover{background:#132040;color:var(--white)}
    .sidebar-item.active{background:#132040;color:var(--white);border-left-color:var(--red)}
    .sidebar-home{padding:.75rem 1rem;border-bottom:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column;gap:.4rem}
    .sidebar-home a{font-size:.78rem;color:var(--silver);text-decoration:none;padding:.4rem .6rem;border-radius:5px;transition:all .2s;letter-spacing:.05em}
    .sidebar-home a:hover{color:var(--white);background:rgba(192,21,42,.2)}

    /* MAIN */
    .main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
    .panel-header{background:var(--navy);border-bottom:1px solid rgba(192,21,42,.2);padding:0 2rem;display:flex;align-items:center;gap:1rem;flex-shrink:0}
    .panel-tab{font-family:'Orbitron',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;padding:1rem 0;border-bottom:2px solid var(--red);color:var(--white)}
    .content{padding:2rem;flex:1}
    .section-content{display:none}

    /* DASH */
    .dash-title{font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:900;letter-spacing:.12em;text-transform:uppercase;margin-bottom:1.5rem}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem;margin-bottom:2rem}
    .dash-card{background:var(--navy);border:1px solid rgba(192,21,42,.2);border-radius:8px;padding:1.2rem;text-align:center}
    .dash-card .num{font-family:'Orbitron',sans-serif;font-size:2rem;font-weight:900;color:var(--red-glow);margin-bottom:.3rem}
    .dash-card .lbl{font-size:.72rem;letter-spacing:.15em;text-transform:uppercase;color:var(--silver)}

    /* VIDEOS TABLE */
    .vid-table{width:100%;border-collapse:collapse}
    .vid-table th{text-align:left;font-size:.7rem;letter-spacing:.15em;text-transform:uppercase;color:rgba(168,184,204,.5);padding:.6rem 1rem;border-bottom:1px solid rgba(192,21,42,.2)}
    .vid-table td{padding:.75rem 1rem;border-bottom:1px solid rgba(255,255,255,.04);font-size:.88rem;vertical-align:middle}
    .vid-table tr:hover td{background:rgba(255,255,255,.02)}

    /* SERIES GRID */

    .filter-btn { padding:.5rem 1rem; border-radius:6px; border:1px solid rgba(168,184,204,.18); background:rgba(255,255,255,.04); color:var(--silver); font-family:'Rajdhani',sans-serif; font-size:.8rem; font-weight:700; letter-spacing:.06em; cursor:pointer; transition:all .2s; white-space:nowrap; }
    .filter-btn:hover { border-color:rgba(192,21,42,.4); color:var(--white); }
    .filter-btn.active { background:rgba(192,21,42,.2); border-color:var(--red); color:var(--white); }
    .series-grid-admin{display:flex;flex-direction:column;gap:.75rem}
    .serie-card-adm{background:var(--navy);border:1px solid rgba(192,21,42,.25);border-radius:10px;overflow:hidden;transition:border-color .2s}
    .serie-card-adm.hidden-serie{opacity:.65;border-color:rgba(168,184,204,.12)}
    .serie-card-head{background:linear-gradient(90deg,rgba(192,21,42,.2),rgba(13,21,32,.5));padding:1rem 1.2rem;border-bottom:1px solid rgba(192,21,42,.15);display:flex;align-items:center;justify-content:space-between}
    .serie-card-name{font-family:'Orbitron',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:.08em}
    .badge-vis{font-size:.6rem;padding:2px 8px;border-radius:3px;font-weight:700;letter-spacing:.1em;text-transform:uppercase}
    .badge-vis.vis{background:rgba(29,185,84,.15);color:#1db954;border:1px solid rgba(29,185,84,.3)}
    .badge-vis.hid{background:rgba(168,184,204,.1);color:rgba(168,184,204,.4);border:1px solid rgba(168,184,204,.15)}
    .serie-card-body-adm{padding:1rem 1.2rem}
    .serie-thumb-preview{width:100%;height:65px;object-fit:cover;border-radius:5px;border:1px solid rgba(192,21,42,.2);margin-bottom:.75rem}
    .serie-btns-adm{display:flex;gap:.4rem;flex-wrap:wrap}

    /* BUTTONS */
    .btn-primary{padding:.55rem 1.2rem;background:var(--red);color:#fff;border:none;border-radius:6px;font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .2s}
    .btn-primary:hover{background:var(--red-glow);box-shadow:0 0 14px rgba(255,34,68,.4)}
    .btn-secondary{padding:.5rem 1rem;background:rgba(255,255,255,.04);color:var(--silver);border:1px solid rgba(168,184,204,.15);border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:.08em;cursor:pointer;transition:all .2s}
    .btn-secondary:hover{border-color:rgba(255,34,68,.35);color:var(--white)}
    .btn-green{padding:.5rem 1rem;background:rgba(29,185,84,.12);color:#1db954;border:1px solid rgba(29,185,84,.3);border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;transition:all .2s}
    .btn-green:hover{background:rgba(29,185,84,.25)}
    .btn-danger{padding:.5rem 1rem;background:rgba(192,21,42,.1);color:var(--red-glow);border:1px solid rgba(192,21,42,.3);border-radius:6px;font-family:'Rajdhani',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;transition:all .2s}
    .btn-danger:hover{background:rgba(192,21,42,.25)}

    /* FORM */
    .form-box{background:var(--navy);border:1px solid rgba(192,21,42,.2);border-radius:10px;padding:1.5rem;margin-bottom:1.5rem}
    .form-box-title{font-family:'Orbitron',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;margin-bottom:1.2rem;color:var(--red-glow)}
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;font-size:.7rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(168,184,204,.6);margin-bottom:.45rem;font-weight:700}
    .form-group input,.form-group textarea,.form-group select{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(168,184,204,.18);border-radius:6px;color:var(--white);padding:.65rem .9rem;font-family:'Rajdhani',sans-serif;font-size:.95rem;outline:none;transition:border-color .2s}
    .form-group input:focus,.form-group textarea:focus{border-color:var(--red)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .upload-row{display:flex;gap:.6rem;align-items:center}
    .upload-row input{flex:1}
    .upload-label{padding:.65rem .9rem;background:rgba(192,21,42,.15);border:1px solid rgba(192,21,42,.35);border-radius:6px;color:var(--red-glow);font-size:.72rem;font-weight:700;cursor:pointer;white-space:nowrap;text-transform:uppercase;letter-spacing:.08em}
    .img-preview-row{display:none;margin-top:.5rem;align-items:center;gap:.75rem}
    .img-preview-row img{height:55px;border-radius:4px;border:1px solid rgba(192,21,42,.3);object-fit:cover}
    .img-preview-row button{background:none;border:none;color:rgba(255,34,68,.7);font-size:.8rem;cursor:pointer;font-family:'Rajdhani',sans-serif}

    /* MODAL */
    .modal-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:1rem}
    .modal-overlay.active{display:flex}
    .modal{background:var(--navy);border:1px solid rgba(192,21,42,.35);border-radius:12px;width:100%;max-width:500px;padding:2rem;position:relative;max-height:92vh;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;animation:up .3s ease}
    @keyframes up{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .modal-title{font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:900;letter-spacing:.15em;text-transform:uppercase;margin-bottom:1.5rem}
    .modal-title span{color:var(--red-glow)}
    .modal-x{position:absolute;top:1rem;right:1.2rem;background:none;border:none;color:var(--silver);font-size:1.3rem;cursor:pointer}
    .modal-x:hover{color:var(--red-glow)}
    .modal-footer{margin-top:1.5rem}
    .modal-footer button{width:100%;padding:.85rem;background:var(--red);color:#fff;border:none;border-radius:6px;font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;transition:all .25s}
    .modal-footer button:hover{background:var(--red-glow);box-shadow:0 0 20px rgba(255,34,68,.4)}

    /* PREVIEW MODAL */
    /* removed preview-inner */.preview-inner{background:var(--navy);border:1px solid rgba(192,21,42,.35);border-radius:12px;width:100%;max-width:960px;animation:up .3s ease;overflow:hidden}
    .preview-header{padding:1rem 1.5rem;border-bottom:1px solid rgba(168,184,204,.1);display:flex;align-items:center;justify-content:space-between}
    .preview-title{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;letter-spacing:.1em}
    .preview-ep{display:inline-block;background:var(--red);font-size:.7rem;padding:2px 8px;border-radius:3px;margin-left:8px}

    /* TOAST */
    .toast{position:fixed;bottom:2rem;right:2rem;z-index:999;background:var(--navy);border-left:3px solid var(--red);border-radius:6px;padding:.85rem 1.2rem;font-size:.88rem;transform:translateX(120%);transition:transform .3s;max-width:280px;box-shadow:0 6px 25px rgba(0,0,0,.5)}
    .toast.show{transform:translateX(0)}

    /* QEP MODAL */

    /* EP MANAGEMENT PANEL */
    .serie-panel { background:var(--navy); border:1px solid rgba(192,21,42,.25); border-radius:12px; margin-bottom:1.5rem; overflow:hidden; }
    .serie-panel-head { background:linear-gradient(90deg,rgba(192,21,42,.18),rgba(13,21,32,.6)); padding:1rem 1.4rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; cursor:pointer; user-select:none; }
    .serie-panel-head:hover { background:linear-gradient(90deg,rgba(192,21,42,.25),rgba(13,21,32,.7)); }
    .serie-panel-left { display:flex; align-items:center; gap:.85rem; }
    .serie-panel-name { font-family:'Orbitron',sans-serif; font-size:.85rem; font-weight:900; letter-spacing:.08em; }
    .serie-panel-meta { font-size:.72rem; color:var(--silver); }
    .serie-panel-arrow { color:var(--silver); font-size:.8rem; transition:transform .2s; }
    .serie-panel-arrow.open { transform:rotate(180deg); }
    .serie-panel-body { display:none !important; padding:1.2rem 1.4rem; border-top:1px solid rgba(192,21,42,.15); }
    .serie-panel-body.open { display:block !important; }
    .ep-actions-bar { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:1.2rem; align-items:center; }
    .ep-select-input { padding:.5rem .8rem; background:rgba(255,255,255,.05); border:1px solid rgba(168,184,204,.18); border-radius:6px; color:var(--white); font-family:'Rajdhani',sans-serif; font-size:.88rem; width:140px; outline:none; }
    .ep-select-input:focus { border-color:var(--red); }
    /* EP CARDS */
    .ep-list { display:flex; flex-direction:column; gap:.6rem; margin-top:.25rem; }
    .ep-item { background:rgba(255,255,255,.03); border:1px solid rgba(168,184,204,.1); border-radius:8px; padding:.85rem 1rem; transition:border-color .2s; }
    .ep-item:hover { border-color:rgba(192,21,42,.3); }
    .ep-item.ep-selected { border-color:rgba(192,21,42,.5); background:rgba(192,21,42,.07); }
    .ep-item-top { display:flex; align-items:center; gap:.75rem; margin-bottom:.7rem; }
    .ep-badge-label { font-family:'Orbitron',sans-serif; font-size:.72rem; font-weight:700; letter-spacing:.08em; color:var(--red-glow); background:rgba(192,21,42,.12); border:1px solid rgba(192,21,42,.3); border-radius:4px; padding:2px 8px; white-space:nowrap; }
    .ep-item-row { display:flex; align-items:center; gap:.75rem; margin-bottom:.5rem; }
    .ep-item-row:last-child { margin-bottom:0; }
    .ep-item-label { font-size:.65rem; letter-spacing:.15em; text-transform:uppercase; color:rgba(168,184,204,.45); font-weight:700; width:90px; flex-shrink:0; }
    .ep-field-link { flex:1; background:rgba(255,255,255,.05); border:1px solid rgba(168,184,204,.15); border-radius:6px; color:var(--white); padding:.5rem .85rem; font-family:'Rajdhani',sans-serif; font-size:.92rem; outline:none; transition:border-color .2s; }
    .ep-field-link:focus { border-color:var(--red); background:rgba(13,21,32,.9); }
    .ep-field-season { width:70px; background:rgba(255,255,255,.05); border:1px solid rgba(168,184,204,.15); border-radius:6px; color:var(--white); padding:.5rem .65rem; font-family:'Rajdhani',sans-serif; font-size:.92rem; outline:none; text-align:center; transition:border-color .2s; }
    .ep-field-season:focus { border-color:var(--red); }

    .qep-ep-list{display:flex;gap:.5rem;overflow-x:auto;padding:1rem 0;flex-wrap:wrap}
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-logo">üé≠ M√ÅSCARA SECRETA</span>
    <span style="color:rgba(255,255,255,.4)">‚Ä∫</span>
    <span style="font-size:.82rem;color:rgba(255,255,255,.8)">Admin</span>
  </div>
  <div class="topbar-right">
    <span id="topbar-date" style="font-size:.78rem;color:rgba(255,255,255,.7)"></span>
    <a href="index.html" target="_blank" class="topbar-link">üåê Ver Site</a>
    <a href="#" onclick="confirmLogout()" class="topbar-link" style="color:rgba(255,100,100,.8)">Sair</a>
  </div>
</div>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-home">
      <a href="index.html" target="_blank">üåê Site P√∫blico</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Conte√∫do</div>
      <div class="sidebar-item active" onclick="showSection('dashboard')"><span>üìä</span> Dashboard</div>
      <div class="sidebar-item" onclick="showSection('videos')"><span>üé¨</span> V√≠deos</div>
      <div class="sidebar-item" onclick="showSection('add-video')"><span>‚ûï</span> Adicionar</div>
      <div class="sidebar-item" onclick="showSection('series')"><span>üì∫</span> S√©ries</div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Sistema</div>
      <div class="sidebar-item" onclick="showSection('config')"><span>‚öôÔ∏è</span> Configura√ß√µes</div>
      <div class="sidebar-item" onclick="confirmLogout()"><span>üö™</span> Sair</div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <!-- DASHBOARD -->
    <div id="sec-dashboard" class="section-content" style="display:block">
      <div class="panel-header"><div class="panel-tab">üìä Dashboard</div></div>
      <div class="content">
        <div class="dash-title">Painel Principal</div>
        <div class="dash-grid" id="dash-grid"></div>
        <div class="dash-title" style="font-size:.9rem;margin-bottom:1rem">√öltimos V√≠deos</div>
        <div id="dash-recent"></div>
      </div>
    </div>

    <!-- V√çDEOS -->
    <div id="sec-videos" class="section-content">
      <div class="panel-header"><div class="panel-tab">üé¨ V√≠deos</div></div>
      <div class="content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
          <div class="dash-title" style="margin-bottom:0">Todos os V√≠deos</div>
          <button class="btn-primary" onclick="showSection('add-video')">‚ûï Adicionar</button>
        </div>
        <div id="videos-list"></div>
      </div>
    </div>

    <!-- ADICIONAR V√çDEO -->
    <div id="sec-add-video" class="section-content">
      <div class="panel-header"><div class="panel-tab">‚ûï Adicionar V√≠deo</div></div>
      <div class="content">
        <div class="form-box">
          <div class="form-box-title">Novo V√≠deo</div>
          <div class="form-row">
            <div class="form-group">
              <label>T√≠tulo do V√≠deo *</label>
              <input type="text" id="v-title" placeholder="Ex: A Identidade Revelada">
            </div>
            <div class="form-group">
              <label>Epis√≥dio / Parte</label>
              <input type="text" id="v-ep" placeholder="Ex: EP 01">
            </div>
          </div>
          <div class="form-group">
            <label>Link do V√≠deo *</label>
            <input type="text" id="v-link" placeholder="https://www.youtube.com/watch?v=...">
          </div>
          <div class="form-group">
            <label>Thumbnail (opcional)</label>
            <div class="upload-row">
              <input type="text" id="v-img" placeholder="URL ou use o bot√£o de upload">
              <label for="v-img-file" class="upload-label">üìÅ Upload</label>
              <input id="v-img-file" type="file" accept="image/*" style="display:none" onchange="handleImgUpload(this,'v-img','v-img-prev')">
            </div>
            <div class="img-preview-row" id="v-img-prev">
              <img id="v-img-prev-img">
              <button onclick="clearImg('v-img','v-img-prev','v-img-file')">‚úï Remover</button>
            </div>
          </div>
          <button class="btn-primary" style="width:100%;padding:.85rem;margin-top:.5rem" onclick="addVideo()">‚úî Adicionar V√≠deo</button>
        </div>
      </div>
    </div>

    <!-- S√âRIES -->
    <div id="sec-series" class="section-content">
      <div class="panel-header"><div class="panel-tab">üì∫ S√©ries</div></div>
      <div class="content">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap">
          <div class="dash-title" style="margin-bottom:0">S√©ries Cadastradas</div>
          <button class="btn-primary" onclick="openModal('new-series-modal')">‚ûï Nova S√©rie</button>
        </div>
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:1.2rem;flex-wrap:wrap">
          <div style="position:relative;flex:1;min-width:180px">
            <input type="text" id="series-search" placeholder="üîç  Buscar s√©rie..." oninput="filterSeriesGrid()"
              style="width:100%;padding:.6rem 1rem .6rem 2.2rem;background:rgba(255,255,255,.05);border:1px solid rgba(168,184,204,.18);border-radius:8px;color:var(--white);font-family:'Rajdhani',sans-serif;font-size:.92rem;outline:none;transition:border-color .2s"
              onfocus="this.style.borderColor='rgba(192,21,42,.5)'" onblur="this.style.borderColor='rgba(168,184,204,.18)'">
            <span style="position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:rgba(168,184,204,.4);pointer-events:none;font-size:.85rem">üîç</span>
          </div>
          <button id="filter-all" class="filter-btn active" onclick="setSeriesFilter('all')">Todas</button>
          <button id="filter-vis" class="filter-btn" onclick="setSeriesFilter('visible')">üëÅ Vis√≠veis</button>
          <button id="filter-hid" class="filter-btn" onclick="setSeriesFilter('hidden')">üôà Ocultas</button>
        </div>
        <div id="series-empty-msg" style="display:none;text-align:center;padding:2rem;color:rgba(168,184,204,.3);font-size:.85rem">Nenhuma s√©rie encontrada</div>
        <div class="series-grid-admin" id="series-grid"></div>
      </div>
    </div>

    <!-- CONFIG -->
    <div id="sec-config" class="section-content">
      <div class="panel-header"><div class="panel-tab">‚öôÔ∏è Configura√ß√µes</div></div>
      <div class="content">
        <div class="form-box">
          <div class="form-box-title">Alterar Senha</div>
          <div class="form-group"><label>Senha Atual</label><input type="password" id="cur-pass" placeholder="Senha atual"></div>
          <div class="form-group"><label>Nova Senha</label><input type="password" id="new-pass" placeholder="Nova senha"></div>
          <div class="form-group"><label>Confirmar Senha</label><input type="password" id="confirm-pass" placeholder="Repita a senha"></div>
          <button class="btn-primary" onclick="changePass()">‚úî Alterar Senha</button>
        </div>
        <div class="form-box" style="border-color:rgba(29,185,84,.25)">
          <div class="form-box-title" style="color:#1db954">üíæ Backup dos Dados</div>
          <p style="font-size:.85rem;color:var(--silver);margin-bottom:1rem">Exporte todos os seus v√≠deos e s√©ries em um arquivo JSON. Guarde como backup ou transfira para outro dispositivo.</p>
          <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1.5rem">
            <button class="btn-green" onclick="exportBackup()">‚¨á Exportar Backup</button>
          </div>
          <p style="font-size:.85rem;color:var(--silver);margin-bottom:.75rem">Importe um arquivo de backup para restaurar os dados. <b style="color:var(--red-glow)">Aten√ß√£o: substitui os dados atuais.</b></p>
          <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap">
            <label for="import-file" class="btn-secondary" style="cursor:pointer;padding:.5rem 1rem;display:inline-flex;align-items:center;gap:.5rem">‚¨Ü Escolher arquivo JSON</label>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importBackup(this)">
            <span id="import-filename" style="font-size:.8rem;color:var(--silver);font-style:italic"></span>
          </div>
          <div id="import-preview" style="display:none;margin-top:1rem;padding:.85rem 1rem;background:rgba(29,185,84,.06);border:1px solid rgba(29,185,84,.2);border-radius:8px">
            <div style="font-size:.72rem;letter-spacing:.15em;text-transform:uppercase;color:#1db954;margin-bottom:.5rem;font-weight:700">üìã Conte√∫do do backup</div>
            <div id="import-preview-text" style="font-size:.85rem;color:var(--silver)"></div>
            <div style="margin-top:.85rem;display:flex;gap:.6rem">
              <button class="btn-green" onclick="confirmImport()">‚úî Confirmar Importa√ß√£o</button>
              <button class="btn-secondary" onclick="cancelImport()">‚úï Cancelar</button>
            </div>
          </div>
        </div>
        <div class="form-box" style="border-color:rgba(192,21,42,.4)">
          <div class="form-box-title" style="color:var(--red-glow)">Zona de Perigo</div>
          <p style="font-size:.85rem;color:var(--silver);margin-bottom:1rem">Apaga todos os v√≠deos. Irrevers√≠vel.</p>
          <button class="btn-danger" onclick="clearAll()" style="margin-bottom:.75rem">üóë Apagar Todos os V√≠deos</button>
          <p style="font-size:.85rem;color:var(--silver);margin:.75rem 0">Apaga todas as s√©ries (v√≠deos permanecem). Irrevers√≠vel.</p>
          <button class="btn-danger" onclick="clearAllSeries()">üóë Apagar Todas as S√©ries</button>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /layout -->

<div class="toast" id="toast"></div>

<!-- MODAL: NOVA S√âRIE -->
<div class="modal-overlay" id="new-series-modal">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('new-series-modal')">‚úï</button>
    <div class="modal-title">Nova <span>S√©rie</span></div>
    <div class="form-group">
      <label>Nome da S√©rie *</label>
      <input type="text" id="s-name" placeholder="Ex: M√°scara Secreta">
    </div>
    <div class="form-group">
      <label>Descri√ß√£o</label>
      <textarea id="s-desc" rows="2" placeholder="Sobre a s√©rie..." style="resize:vertical"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Prefixo do EP</label>
        <input type="text" id="s-prefix" placeholder="EP, Parte, Cap...">
      </div>
      <div class="form-group">
        <label>Pr√≥ximo EP n¬∫</label>
        <input type="number" id="s-nexep" value="1" min="1">
      </div>
    </div>
    <div class="form-group">
      <label>T√≠tulo padr√£o do v√≠deo</label>
      <input type="text" id="s-title" placeholder="Ex: A Identidade Revelada">
    </div>
    <div class="form-group">
      <label>Banner (URL ou upload)</label>
      <div class="upload-row">
        <input type="text" id="s-banner" placeholder="https://...">
        <label for="s-banner-file" class="upload-label">üìÅ</label>
        <input id="s-banner-file" type="file" accept="image/*" style="display:none" onchange="handleImgUpload(this,'s-banner','s-banner-prev')">
      </div>
      <div class="img-preview-row" id="s-banner-prev">
        <img id="s-banner-prev-img" style="width:110px">
        <button onclick="clearImg('s-banner','s-banner-prev','s-banner-file')">‚úï</button>
      </div>
    </div>
    <div class="form-group">
      <label>Thumbnail padr√£o dos EPs (URL ou upload)</label>
      <div class="upload-row">
        <input type="text" id="s-img" placeholder="https://...">
        <label for="s-img-file" class="upload-label">üìÅ</label>
        <input id="s-img-file" type="file" accept="image/*" style="display:none" onchange="handleImgUpload(this,'s-img','s-img-prev')">
      </div>
      <div class="img-preview-row" id="s-img-prev">
        <img id="s-img-prev-img">
        <button onclick="clearImg('s-img','s-img-prev','s-img-file')">‚úï</button>
      </div>
    </div>
    <div class="form-group">
      <label>Como abrir na p√°gina inicial?</label>
      <div style="display:flex;gap:.75rem;margin-top:.5rem">
        <div id="opt-page" onclick="selectOpenMode('page')" style="flex:1;padding:.75rem;border:1px solid rgba(192,21,42,.5);border-radius:8px;cursor:pointer;background:rgba(192,21,42,.06)">
          <div style="font-size:.82rem;font-weight:700;margin-bottom:.2rem">üåê P√°gina pr√≥pria</div>
          <div style="font-size:.72rem;color:var(--silver)">Abre serie.html</div>
        </div>
        <div id="opt-inline" onclick="selectOpenMode('inline')" style="flex:1;padding:.75rem;border:1px solid rgba(168,184,204,.1);border-radius:8px;cursor:pointer">
          <div style="font-size:.82rem;font-weight:700;margin-bottom:.2rem">‚ñ∂ Assistir inline</div>
          <div style="font-size:.72rem;color:var(--silver)">Player na p√°gina</div>
        </div>
      </div>
      <input type="hidden" id="s-open-mode" value="page">
    </div>
    <div class="modal-footer">
      <button onclick="saveSeries()">‚úî Salvar S√©rie</button>
    </div>
  </div>
</div>

<!-- MODAL: EP R√ÅPIDO -->
<div class="modal-overlay" id="quick-ep-modal">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('quick-ep-modal')">‚úï</button>
    <div class="modal-title" id="qep-title">Novo <span>EP</span></div>
    <p id="qep-info" style="font-size:.82rem;color:var(--silver);margin-bottom:1.2rem"></p>
    <div class="form-group">
      <label>Temporada</label>
      <input type="number" id="qep-season" value="1" min="1" placeholder="1">
    </div>
    <div class="form-group">
      <label>Link do V√≠deo *</label>
      <input type="text" id="qep-link" placeholder="https://www.youtube.com/watch?v=..." onkeydown="if(event.key==='Enter')submitQuickEp()">
    </div>
    <div class="form-group">
      <label>Thumbnail (opcional)</label>
      <div class="upload-row">
        <input type="text" id="qep-img" placeholder="URL ou upload">
        <label for="qep-img-file" class="upload-label">üìÅ</label>
        <input id="qep-img-file" type="file" accept="image/*" style="display:none" onchange="handleImgUpload(this,'qep-img','qep-img-prev')">
      </div>
      <div class="img-preview-row" id="qep-img-prev">
        <img id="qep-img-prev-img">
        <button onclick="clearImg('qep-img','qep-img-prev','qep-img-file')">‚úï</button>
      </div>
    </div>
    <div class="form-group">
      <label>Aparecer na grade geral?</label>
      <div style="display:flex;gap:.6rem;margin-top:.4rem">
        <div id="qep-opt-sim" onclick="setEpGrade(true)"
          style="flex:1;padding:.65rem .9rem;border-radius:7px;cursor:pointer;text-align:center;border:1px solid rgba(29,185,84,.5);background:rgba(29,185,84,.08);transition:.2s">
          <div style="font-size:.85rem;font-weight:700;color:#1db954">‚úî Sim</div>
          <div style="font-size:.68rem;color:var(--silver);margin-top:2px">Aparece no index</div>
        </div>
        <div id="qep-opt-nao" onclick="setEpGrade(false)"
          style="flex:1;padding:.65rem .9rem;border-radius:7px;cursor:pointer;text-align:center;border:1px solid rgba(168,184,204,.12);background:transparent;transition:.2s">
          <div style="font-size:.85rem;font-weight:700;color:var(--silver)">‚úï N√£o</div>
          <div style="font-size:.68rem;color:var(--silver);margin-top:2px">S√≥ na s√©rie</div>
        </div>
      </div>
      <input type="hidden" id="qep-grade" value="true">
    </div>
    <div class="modal-footer">
      <button onclick="submitQuickEp()">‚ñ∂ Adicionar EP</button>
    </div>
  </div>
</div>


<script>
  /* ===== AUTH ===== */
  var PASS_KEY = 'ms_admin_pass';
  function getPass() { return localStorage.getItem(PASS_KEY) || 'dr3wnic0'; }

  if (!sessionStorage.getItem('ms_admin_auth')) {
    var entered = prompt('üé≠ M√°scara Secreta ‚Äî Senha Admin:');
    if (entered !== getPass()) {
      alert('Senha incorreta!');
      window.location.href = 'index.html';
    } else {
      sessionStorage.setItem('ms_admin_auth', '1');
    }
  }

  /* ===== DATA ===== */
  var videos = JSON.parse(localStorage.getItem('ms_videos') || '[]');
  var series = JSON.parse(localStorage.getItem('ms_series') || '[]');

  function saveVideos() {
    try { localStorage.setItem('ms_videos', JSON.stringify(videos)); }
    catch(e) { toast('‚ùå Erro ao salvar! Imagem muito grande. Use URL em vez de upload.'); }
  }
  function saveSeries_() {
    try { localStorage.setItem('ms_series', JSON.stringify(series)); }
    catch(e) { toast('‚ùå Erro ao salvar s√©rie! Imagem muito grande. Use URL em vez de upload.'); throw e; }
  }

  /* ===== UTILS ===== */
  function toast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(function(){ t.classList.remove('show'); }, 3000);
  }
  function openModal(id)  { document.getElementById(id).classList.add('active'); }
  function closeModal(id) { document.getElementById(id).classList.remove('active'); }


  /* ===== NAV ===== */
  function showSection(id) {
    document.querySelectorAll('.section-content').forEach(function(s){ s.style.display='none'; });
    document.querySelectorAll('.sidebar-item').forEach(function(s){ s.classList.remove('active'); });
    document.getElementById('sec-'+id).style.display = 'block';
    // Highlight sidebar item
    document.querySelectorAll('.sidebar-item').forEach(function(s){
      if (s.getAttribute('onclick') && s.getAttribute('onclick').indexOf("'"+id+"'") > -1) s.classList.add('active');
    });
    if (id === 'dashboard') renderDashboard();
    if (id === 'videos') renderVideosList();
    if (id === 'series') renderSeriesGrid();
  }

  /* ===== DASHBOARD ===== */
  function renderDashboard() {
    document.getElementById('dash-grid').innerHTML =
      '<div class="dash-card"><div class="num">' + videos.length + '</div><div class="lbl">V√≠deos</div></div>' +
      '<div class="dash-card"><div class="num">' + series.length + '</div><div class="lbl">S√©ries</div></div>' +
      '<div class="dash-card"><div class="num">' + series.filter(function(s){return !s.hidden}).length + '</div><div class="lbl">S√©ries Vis√≠veis</div></div>';

    var recent = videos.slice(0, 5);
    document.getElementById('dash-recent').innerHTML = recent.length === 0
      ? '<p style="color:var(--silver);font-size:.85rem">Nenhum v√≠deo ainda.</p>'
      : recent.map(function(v, i) {
          return '<div style="display:flex;align-items:center;gap:1rem;padding:.75rem 1rem;background:var(--navy);border:1px solid rgba(192,21,42,.15);border-radius:8px;margin-bottom:.6rem">'
            + '<div style="flex:1;min-width:0"><div style="font-weight:700;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + v.title + '</div>'
            + '<div style="font-size:.78rem;color:var(--red);margin-top:2px">' + (v.ep||'‚Äî') + '</div></div>'
            + '<a class="btn-secondary" style="font-size:.7rem;padding:.35rem .75rem;text-decoration:none" href="' + (v.link||'#') + '" target="_blank" rel="noopener">üîó Abrir</a>'
            + '</div>';
        }).join('');
  }

  /* ===== V√çDEOS ===== */
  function renderVideosList() {
    var el = document.getElementById('videos-list');
    if (!videos.length) { el.innerHTML = '<p style="color:var(--silver)">Nenhum v√≠deo cadastrado.</p>'; return; }
    el.innerHTML = '<table class="vid-table"><thead><tr><th>T√≠tulo</th><th>EP</th><th>Link</th><th></th></tr></thead><tbody>'
      + videos.map(function(v, i) {
          return '<tr><td style="font-weight:700">' + v.title + '</td>'
            + '<td style="color:var(--red);font-weight:700">' + (v.ep||'‚Äî') + '</td>'
            + '<td style="color:var(--silver);font-size:.8rem;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + (v.link||'') + '</td>'
            + '<td style="display:flex;gap:.4rem">'
            + '<a class="btn-secondary" style="font-size:.7rem;padding:.35rem .7rem;text-decoration:none;display:inline-flex;align-items:center" href="' + (videos[i]?videos[i].link:'#') + '" target="_blank" rel="noopener">üîó</a>'
            + '<button class="btn-danger" style="font-size:.7rem;padding:.35rem .7rem" onclick="deleteVideo(' + i + ')">üóë</button>'
            + '</td></tr>';
        }).join('')
      + '</tbody></table>';
  }

  function deleteVideo(i) {
    if (!confirm('Remover "' + videos[i].title + '"?')) return;
    videos.splice(i, 1); saveVideos(); renderVideosList(); renderDashboard();
    toast('üóë V√≠deo removido.');
  }


  /* ===== IMAGE UPLOAD ===== */
  function compressImage(file, maxW, maxH, quality, callback) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        var ratio  = Math.min(maxW / img.width, maxH / img.height, 1);
        canvas.width  = Math.round(img.width  * ratio);
        canvas.height = Math.round(img.height * ratio);
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        callback(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function handleImgUpload(input, urlId, prevId) {
    var file = input.files[0]; if (!file) return;
    // Compress: banner max 1200x600, thumbnail max 600x400, quality 0.75
    var isBanner = urlId.indexOf('banner') > -1;
    var maxW = isBanner ? 1200 : 600;
    var maxH = isBanner ? 600  : 400;
    compressImage(file, maxW, maxH, 0.75, function(dataUrl) {
      document.getElementById(urlId).value = dataUrl;
      document.getElementById(prevId + '-img').src = dataUrl;
      document.getElementById(prevId).style.display = 'flex';
      // Show size warning if still large
      var kb = Math.round(dataUrl.length * 0.75 / 1024);
      if (kb > 400) toast('‚ö† Imagem: ' + kb + 'KB ‚Äî tente uma menor se travar');
    });
  }

  function clearImg(urlId, prevId, fileId) {
    document.getElementById(urlId).value = '';
    document.getElementById(fileId).value = '';
    document.getElementById(prevId).style.display = 'none';
  }

  /* ===== S√âRIES ===== */
  function selectOpenMode(mode) {
    document.getElementById('s-open-mode').value = mode;
    document.getElementById('opt-page').style.borderColor   = mode === 'page'   ? 'rgba(192,21,42,.5)' : 'rgba(168,184,204,.1)';
    document.getElementById('opt-page').style.background    = mode === 'page'   ? 'rgba(192,21,42,.06)' : 'transparent';
    document.getElementById('opt-inline').style.borderColor = mode === 'inline' ? 'rgba(192,21,42,.5)' : 'rgba(168,184,204,.1)';
    document.getElementById('opt-inline').style.background  = mode === 'inline' ? 'rgba(192,21,42,.06)' : 'transparent';
  }

  function saveSeries() {
    console.log("saveSeries chamado");
    var name     = document.getElementById('s-name').value.trim();
    var desc     = document.getElementById('s-desc').value.trim();
    var prefix   = document.getElementById('s-prefix').value.trim() || 'EP';
    var nextEp   = parseInt(document.getElementById('s-nexep').value) || 1;
    var title    = document.getElementById('s-title').value.trim();
    var banner   = document.getElementById('s-banner').value.trim();
    var img      = document.getElementById('s-img').value.trim();
    var openMode = document.getElementById('s-open-mode').value || 'page';

    if (!name) { toast('‚ö† Preencha o nome da s√©rie!'); return; }

    series.push({
      name: name, desc: desc, prefix: prefix, nextEp: nextEp,
      titleTemplate: title, banner: banner, defaultImg: img,
      openMode: openMode, hidden: true
    });
    try {
      saveSeries_();
    } catch(e) {
      series.pop(); // rollback
      return;
    }

    // Clear form
    ['s-name','s-desc','s-prefix','s-title','s-banner','s-img'].forEach(function(id){
      document.getElementById(id).value = '';
    });
    document.getElementById('s-nexep').value = 1;
    clearImg('s-banner','s-banner-prev','s-banner-file');
    clearImg('s-img','s-img-prev','s-img-file');
    selectOpenMode('page');

    closeModal('new-series-modal');
    renderSeriesGrid();
    toast('‚úÖ S√©rie cadastrada! (oculta por padr√£o)');
  }

  /* ===== FILTRO DE S√âRIES ===== */
  var _seriesFilter = 'all';

  function setSeriesFilter(f) {
    _seriesFilter = f;
    ['all','vis','hid'].forEach(function(k){
      var btn = document.getElementById('filter-' + k);
      if (btn) btn.classList.toggle('active', k === f || (f==='visible'&&k==='vis') || (f==='hidden'&&k==='hid') || (f==='all'&&k==='all'));
    });
    filterSeriesGrid();
  }

  function filterSeriesGrid() {
    var q = (document.getElementById('series-search') ? document.getElementById('series-search').value.trim().toLowerCase() : '');
    var panels = document.querySelectorAll('#series-grid .serie-panel');
    var visCount = 0;
    panels.forEach(function(panel, i) {
      var idx = parseInt(panel.id.replace('sp-',''));
      var s   = series[idx];
      if (!s) { panel.style.display = 'none'; return; }
      var matchSearch = !q || s.name.toLowerCase().indexOf(q) > -1;
      var matchFilter = _seriesFilter === 'all'
        || (_seriesFilter === 'visible' && !s.hidden)
        || (_seriesFilter === 'hidden'  &&  s.hidden);
      var show = matchSearch && matchFilter;
      panel.style.display = show ? '' : 'none';
      if (show) visCount++;
    });
    var empty = document.getElementById('series-empty-msg');
    if (empty) empty.style.display = (visCount === 0 && series.length > 0) ? 'block' : 'none';
  }

  function getSeriesEps(i) {
    var s = series[i];
    return videos.filter(function(v){
      return v.ep && v.ep.indexOf(s.prefix+' ')===0 && (v.title===s.titleTemplate||v.title===s.name);
    });
  }

  function renderSeriesGrid() {
    var grid = document.getElementById('series-grid');
    if (!series.length) {
      grid.innerHTML = '<div style="text-align:center;padding:4rem 2rem;color:rgba(168,184,204,.25)">'
        + '<div style="font-size:3rem;margin-bottom:1rem">\u{1F4FA}</div>'
        + '<div style="font-family:\'Orbitron\',sans-serif;font-size:.8rem;letter-spacing:.15em;text-transform:uppercase">Nenhuma s\u00e9rie cadastrada</div></div>';
      return;
    }
    grid.innerHTML = '';
    series.forEach(function(s, i) {
      var hidden  = s.hidden || false;
      var eps     = getSeriesEps(i);
      var panelNode = buildSeriePanel(i, s, eps, hidden);
      panelNode.className = 'serie-panel';
      panelNode.id = 'sp-' + i;
      grid.appendChild(panelNode);
    });
    filterSeriesGrid();
  }

  function buildSeriePanel(i, s, eps, hidden) {
    var epCount = eps.length;
    // Build using DOM to avoid HTML structure bugs
    var panel = document.createElement('div');

    // HEAD
    var head = document.createElement('div');
    head.className = 'serie-panel-head';
    head.setAttribute('onclick', 'togglePanel(' + i + ')');

    var left = document.createElement('div');
    left.className = 'serie-panel-left';
    var badge = document.createElement('span');
    badge.className = 'badge-vis ' + (hidden ? 'hid' : 'vis');
    badge.textContent = hidden ? 'OCULTA' : 'VIS√çVEL';
    var info = document.createElement('div');
    info.innerHTML = '<div class="serie-panel-name">' + s.name + '</div>'
      + '<div class="serie-panel-meta">' + s.prefix + ' ¬∑ Pr√≥x: <b style="color:var(--red-glow)">'
      + String(s.nextEp).padStart(2,'0') + '</b> ¬∑ ' + epCount + ' ep' + (epCount!==1?'s':'') + '</div>';
    left.appendChild(badge);
    left.appendChild(info);

    var right = document.createElement('div');
    right.style.cssText = 'display:flex;align-items:center;gap:.75rem';
    right.setAttribute('onclick', 'event.stopPropagation()');

    var btnAdd = document.createElement('button');
    btnAdd.className = 'btn-primary';
    btnAdd.style.cssText = 'font-size:.65rem;padding:.4rem .75rem';
    btnAdd.textContent = '‚ö° +EP';
    btnAdd.setAttribute('onclick', 'openQuickEp(' + i + ')');

    var btnVis = document.createElement('button');
    btnVis.className = hidden ? 'btn-green' : 'btn-secondary';
    btnVis.style.cssText = 'font-size:.65rem;padding:.4rem .75rem';
    btnVis.textContent = hidden ? 'üëÅ' : 'üôà';
    btnVis.setAttribute('onclick', 'toggleVisible(' + i + ')');

    var btnDel = document.createElement('button');
    btnDel.className = 'btn-danger';
    btnDel.style.cssText = 'font-size:.65rem;padding:.4rem .75rem';
    btnDel.textContent = '‚úï';
    btnDel.setAttribute('onclick', 'deleteSeries(' + i + ')');

    var arrow = document.createElement('span');
    arrow.className = 'serie-panel-arrow';
    arrow.id = 'sp-arrow-' + i;
    arrow.textContent = '‚ñº';

    right.appendChild(btnAdd);
    right.appendChild(btnVis);
    right.appendChild(btnDel);
    right.appendChild(arrow);

    head.appendChild(left);
    head.appendChild(right);

    // BODY
    var body = document.createElement('div');
    body.className = 'serie-panel-body';
    body.id = 'sp-body-' + i;
    body.innerHTML = buildSerieBody(i, s, eps);

    panel.appendChild(head);
    panel.appendChild(body);
    return panel;
  }

  function buildSerieBody(i, s, eps) {
    var h = '';

    // A√ß√µes globais
    h += '<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.2rem;padding-bottom:1rem;border-bottom:1px solid rgba(168,184,204,.08)">'
      + '<button class="btn-primary" style="font-size:.7rem" onclick="openQuickEp(' + i + ')">‚ö° Adicionar EP ' + String(s.nextEp).padStart(2,'0') + '</button>'
      + '<button class="btn-secondary" style="font-size:.7rem" onclick="editEpNum(' + i + ')">‚úèÔ∏è Alterar N¬∫ EP</button>'
      + '<button class="btn-secondary" style="font-size:.7rem;border-color:rgba(192,21,42,.4);color:var(--red-glow)" onclick="clearSeriesEps(' + i + ')">üóë Apagar todos EPs</button>'
      + '<button class="btn-danger" style="font-size:.7rem" onclick="deleteSeries(' + i + ')">‚úï Excluir S√©rie</button>'
      + '</div>';

    if (!eps.length) {
      h += '<div style="text-align:center;padding:2rem;color:rgba(168,184,204,.3);font-size:.82rem">Nenhum epis√≥dio cadastrado</div>';
      return h;
    }

    // Sele√ß√£o em massa
    h += '<div class="ep-actions-bar">'
      + '<input type="text" class="ep-select-input" id="ep-sel-' + i + '" placeholder="ex: 1-10 ou 1,3,5">'
      + '<button class="btn-secondary" style="font-size:.7rem" onclick="selectEpRange(' + i + ')">‚úî Selecionar</button>'
      + '<button class="btn-secondary" style="font-size:.7rem" onclick="selectAllEps(' + i + ')">‚òë Todos</button>'
      + '<button class="btn-secondary" style="font-size:.7rem" onclick="deselectAllEps(' + i + ')">‚òê Nenhum</button>'
      + '<button class="btn-danger" style="font-size:.7rem;margin-left:auto" onclick="deleteSelectedEps(' + i + ')">üóë Apagar Selecionados</button>'
      + '</div>'
    // Grade controls
    + '<div style="display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap;padding:.65rem .8rem;background:rgba(255,255,255,.03);border:1px solid rgba(168,184,204,.08);border-radius:8px">'
    + '<span style="font-size:.68rem;letter-spacing:.15em;text-transform:uppercase;color:rgba(168,184,204,.5);font-weight:700;margin-right:.25rem">Grade:</span>'
    + '<button class="btn-secondary" style="font-size:.68rem;padding:.35rem .75rem;border-color:rgba(29,185,84,.35);color:#1db954" onclick="setGradeSelected(' + i + ',true)">‚úî Mostrar na grade</button>'
    + '<button class="btn-secondary" style="font-size:.68rem;padding:.35rem .75rem;border-color:rgba(192,21,42,.35);color:var(--red-glow)" onclick="setGradeSelected(' + i + ',false)">‚úï S√≥ na s√©rie</button>'
    + '<button class="btn-secondary" style="font-size:.68rem;padding:.35rem .75rem" onclick="setGradeAll(' + i + ',true)">‚úî Todos na grade</button>'
    + '<button class="btn-secondary" style="font-size:.68rem;padding:.35rem .75rem" onclick="setGradeAll(' + i + ',false)">‚úï Todos s√≥ s√©rie</button>'
    + '</div>';

    // Cards de EP empilhados
    h += '<div class="ep-list">';
    eps.forEach(function(v) {
      var vi = videos.indexOf(v);
      h += '<div class="ep-item" id="ep-row-' + vi + '">'

        // Linha 1: checkbox + badge EP + bot√£o deletar
        + '<div class="ep-item-top">'
        + '<input type="checkbox" class="ep-chk-' + i + '" data-vid="' + vi + '" onchange="updateEpRowStyle(this)" style="accent-color:var(--red);width:16px;height:16px;cursor:pointer;flex-shrink:0">'
        + '<span class="ep-badge-label">' + (v.ep || '‚Äî') + '</span>'
        + '<span style="font-size:.72rem;color:var(--silver);flex:1">T' + (v.season || 1) + '</span>'
        + '<span id="grade-badge-' + vi + '" style="font-size:.6rem;font-weight:700;letter-spacing:.1em;background:rgba(192,21,42,.15);border:1px solid rgba(192,21,42,.3);color:var(--red-glow);padding:2px 6px;border-radius:3px;display:' + (v.gradeOnly === false ? 'inline-block' : 'none') + '">s√≥ s√©rie</span>'
        + '<span id="hidden-ep-badge-' + vi + '" style="font-size:.6rem;font-weight:700;letter-spacing:.1em;background:rgba(100,100,100,.15);border:1px solid rgba(150,150,150,.25);color:#888;padding:2px 6px;border-radius:3px;display:' + (v.hidden ? 'inline-block' : 'none') + '">oculto</span>'
        + '<button id="hide-ep-btn-' + vi + '" class="btn-secondary" style="font-size:.62rem;padding:.28rem .6rem" onclick="toggleHideEp(' + vi + ')">' + (v.hidden ? 'üëÅ Exibir' : 'üôà Ocultar') + '</button>'
        + '<button class="btn-danger" style="font-size:.65rem;padding:.3rem .65rem" onclick="deleteOneEp(' + vi + ',' + i + ')">üóë Excluir</button>'
        + '</div>'

        // Linha 2: campo temporada
        + '<div class="ep-item-row">'
        + '<label class="ep-item-label">Temporada</label>'
        + '<input type="number" class="ep-field-season" value="' + (v.season || 1) + '" min="1" onchange="saveEpSeason(' + vi + ',this.value)">'
        + '</div>'

        // Linha 3: campo link completo
        + '<div class="ep-item-row">'
        + '<label class="ep-item-label">Link do v√≠deo</label>'
        + '<input type="text" class="ep-field-link" value="' + (v.link || '').replace(/"/g, '&quot;') + '" placeholder="https://..." onchange="saveEpLink(' + vi + ',this.value)">'
        + '</div>'

        + '</div>';
    });
    h += '</div>';
    return h;
  }
  function togglePanel(i) {
    var body  = document.getElementById('sp-body-' + i);
    var arrow = document.getElementById('sp-arrow-' + i);
    if (!body) return;
    var isOpen = body.classList.contains('open');
    body.classList.toggle('open', !isOpen);
    if (arrow) arrow.classList.toggle('open', !isOpen);
  }

  // EP inline save
  function saveEpLink(vi, val) {
    if (videos[vi]) { videos[vi].link = val.trim(); saveVideos(); toast('\u2705 Link salvo!'); }
  }
  function saveEpSeason(vi, val) {
    if (videos[vi]) { videos[vi].season = parseInt(val) || 1; saveVideos(); toast('\u2705 Temporada salva!'); }
  }

  // Delete single EP
  function toggleHideEp(vi) {
    if (!videos[vi]) return;
    videos[vi].hidden = !videos[vi].hidden;
    saveVideos();
    var isHidden = videos[vi].hidden;
    var btn   = document.getElementById('hide-ep-btn-' + vi);
    var badge = document.getElementById('hidden-ep-badge-' + vi);
    var row   = document.getElementById('ep-row-' + vi);
    if (btn)   btn.textContent = isHidden ? 'üëÅ Exibir' : 'üôà Ocultar';
    if (badge) badge.style.display = isHidden ? 'inline-block' : 'none';
    if (row)   row.style.opacity = isHidden ? '.4' : '1';
    toast(isHidden ? 'üôà EP ocultado!' : 'üëÅ EP exibido!');
  }

  function deleteOneEp(vi, si) {
    if (!confirm('Remover este EP?')) return;
    videos.splice(vi, 1);
    saveVideos();
    renderSeriesGrid();
    toast('\ud83d\uddd1 EP removido.');
  }

  // Update row highlight when checkbox changes
  function updateEpRowStyle(chk) {
    var row = chk.closest('tr');
    if (row) row.classList.toggle('ep-selected', chk.checked);
  }

  // Toggle all checkboxes + visibility
  function toggleAllEpCheck(si, checked) {
    document.querySelectorAll('.ep-chk-' + si).forEach(function(chk){
      chk.checked = checked;
      updateEpRowStyle(chk);
    });
  }

  function selectAllEps(si) {
    // Mostra todos e marca todos
    document.querySelectorAll('#sp-body-' + si + ' .ep-item').forEach(function(item){
      item.style.display = '';
    });
    toggleAllEpCheck(si, true);
    document.getElementById('ep-sel-' + si).value = '';
  }

  function deselectAllEps(si) {
    // Mostra todos e desmarca todos
    document.querySelectorAll('#sp-body-' + si + ' .ep-item').forEach(function(item){
      item.style.display = '';
    });
    toggleAllEpCheck(si, false);
    document.getElementById('ep-sel-' + si).value = '';
  }

  // Parse range/list input into a Set of numbers
  function parseEpNums(val) {
    var nums = new Set();
    val.split(',').forEach(function(part) {
      part = part.trim();
      if (part.indexOf('-') > -1) {
        var ab = part.split('-');
        var a  = parseInt(ab[0]), b = parseInt(ab[1]);
        if (!isNaN(a) && !isNaN(b)) {
          for (var n = Math.min(a,b); n <= Math.max(a,b); n++) nums.add(n);
        }
      } else {
        var n = parseInt(part);
        if (!isNaN(n)) nums.add(n);
      }
    });
    return nums;
  }

  // Select by range/list AND hide non-matching EPs
  function selectEpRange(si) {
    var input = document.getElementById('ep-sel-' + si);
    if (!input) return;
    var val = input.value.trim();

    // Se vazio, mostra tudo e desmarca
    if (!val) { deselectAllEps(si); return; }

    var nums = parseEpNums(val);
    if (!nums.size) { toast('‚ö† Formato inv√°lido! Use 1-10 ou 1,3,5'); return; }

    var eps     = getSeriesEps(si);
    var matched = 0;

    eps.forEach(function(v) {
      var m   = (v.ep||'').match(/\d+/);
      var num = m ? parseInt(m[0]) : -1;
      var hit = nums.has(num);
      var vi  = videos.indexOf(v);

      // Mostrar/ocultar o card do EP
      var item = document.getElementById('ep-row-' + vi);
      if (item) item.style.display = hit ? '' : 'none';

      // Marcar/desmarcar checkbox
      var chk = document.querySelector('.ep-chk-' + si + '[data-vid="' + vi + '"]');
      if (chk) { chk.checked = hit; updateEpRowStyle(chk); }

      if (hit) matched++;
    });

    toast('‚úî Mostrando ' + matched + ' EP' + (matched!==1?'s':'') + ' de ' + nums.size + ' solicitado' + (nums.size!==1?'s':''));
  }

  // Delete selected EPs
  // Apply grade visibility to selected EPs
  function setHideSelected(si, val) {
    var checked = document.querySelectorAll('.ep-chk-' + si + ':checked');
    if (!checked.length) { toast('‚ö† Selecione EPs primeiro!'); return; }
    var count = 0;
    checked.forEach(function(chk) {
      var vi = parseInt(chk.getAttribute('data-vid'));
      if (!isNaN(vi) && videos[vi]) {
        videos[vi].hidden = val; count++;
        var b = document.getElementById('hidden-ep-badge-' + vi);
        var btn = document.getElementById('hide-ep-btn-' + vi);
        var row = document.getElementById('ep-row-' + vi);
        if (b) b.style.display = val ? 'inline-block' : 'none';
        if (btn) btn.textContent = val ? 'üëÅ Exibir' : 'üôà Ocultar';
        if (row) row.style.opacity = val ? '.4' : '1';
      }
    });
    saveVideos();
    toast((val ? 'üôà ' : 'üëÅ ') + count + ' EP(s) ' + (val ? 'ocultado(s)!' : 'exibido(s)!'));
  }

  function setHideAll(si, val) {
    var eps = getSeriesEps(si);
    if (!eps.length) { toast('‚ö† Nenhum EP.'); return; }
    eps.forEach(function(v) {
      v.hidden = val;
      var vi = videos.indexOf(v);
      var b = document.getElementById('hidden-ep-badge-' + vi);
      var btn = document.getElementById('hide-ep-btn-' + vi);
      var row = document.getElementById('ep-row-' + vi);
      if (b) b.style.display = val ? 'inline-block' : 'none';
      if (btn) btn.textContent = val ? 'üëÅ Exibir' : 'üôà Ocultar';
      if (row) row.style.opacity = val ? '.4' : '1';
    });
    saveVideos();
    toast(val ? 'üôà Todos ocultados!' : 'üëÅ Todos exibidos!');
  }

  function setGradeSelected(si, val) {
    var checked = document.querySelectorAll('.ep-chk-' + si + ':checked');
    if (!checked.length) { toast('‚ö† Selecione EPs primeiro!'); return; }
    var count = 0;
    checked.forEach(function(chk) {
      var vi = parseInt(chk.getAttribute('data-vid'));
      if (!isNaN(vi) && videos[vi]) {
        videos[vi].gradeOnly = val;
        count++;
        // Update badge in DOM
        updateGradeBadge(vi, val);
      }
    });
    saveVideos();
    toast((val ? '‚úî ' : '‚úï ') + count + ' EP(s) ' + (val ? 'aparecer√£o' : 's√≥ aparecem') + (val ? ' na grade!' : ' na s√©rie!'));
  }

  // Apply grade visibility to ALL EPs of this series
  function setGradeAll(si, val) {
    var eps = getSeriesEps(si);
    if (!eps.length) { toast('‚ö† Nenhum EP cadastrado.'); return; }
    eps.forEach(function(v) {
      v.gradeOnly = val;
      var vi = videos.indexOf(v);
      if (vi !== -1) updateGradeBadge(vi, val);
    });
    saveVideos();
    toast((val ? '‚úî Todos' : '‚úï Todos') + ' os EPs ' + (val ? 'na grade!' : 's√≥ na s√©rie!'));
  }

  // Update the grade badge inside an ep-item card
  function updateGradeBadge(vi, val) {
    var badge = document.getElementById('grade-badge-' + vi);
    if (!badge) return;
    if (val === false) {
      badge.textContent = 's√≥ s√©rie';
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  function deleteSelectedEps(si) {
    var checked = document.querySelectorAll('.ep-chk-' + si + ':checked');
    if (!checked.length) { toast('\u26a0 Nenhum EP selecionado!'); return; }
    if (!confirm('Remover ' + checked.length + ' EP(s) selecionado(s)?')) return;
    var toRemove = new Set();
    checked.forEach(function(chk){ toRemove.add(parseInt(chk.getAttribute('data-vid'))); });
    // Remove in reverse order to keep indices valid
    var indices = Array.from(toRemove).sort(function(a,b){return b-a;});
    indices.forEach(function(vi){ videos.splice(vi,1); });
    saveVideos();
    renderSeriesGrid();
    toast('\ud83d\uddd1 ' + indices.length + ' EP(s) removidos.');
  }
  function toggleVisible(i) {
    series[i].hidden = !series[i].hidden;
    saveSeries_();
    renderSeriesGrid();
    filterSeriesGrid();
    toast(series[i].hidden ? 'üôà S√©rie ocultada.' : 'üëÅ S√©rie vis√≠vel!');
  }

  function deleteSeries(i) {
    if (!confirm('Remover a s√©rie "' + series[i].name + '"?')) return;
    series.splice(i, 1); saveSeries_(); renderSeriesGrid();
    toast('üóë S√©rie removida.');
  }

  function editEpNum(i) {
    var n = prompt('Pr√≥ximo EP da s√©rie "' + series[i].name + '":', series[i].nextEp);
    if (n === null) return;
    var num = parseInt(n);
    if (isNaN(num) || num < 1) { toast('‚ö† N√∫mero inv√°lido!'); return; }
    series[i].nextEp = num; saveSeries_(); renderSeriesGrid();
    toast('‚úÖ EP atualizado!');
  }

  function clearSeriesEps(i) {
    var s = series[i];
    var count = videos.filter(function(v){ return v.ep && v.ep.indexOf(s.prefix+' ')===0 && (v.title===s.titleTemplate||v.title===s.name); }).length;
    if (!count) { toast('‚ö† Nenhum EP para remover.'); return; }
    if (!confirm('Remover ' + count + ' EP(s) da s√©rie "' + s.name + '"? Irrevers√≠vel.')) return;
    videos = videos.filter(function(v){ return !(v.ep && v.ep.indexOf(s.prefix+' ')===0 && (v.title===s.titleTemplate||v.title===s.name)); });
    saveVideos(); renderSeriesGrid(); renderDashboard();
    toast('üóë ' + count + ' EP(s) removidos.');
  }

  /* ===== EP R√ÅPIDO ===== */
  var _qepIdx = null;

  function openQuickEp(i) {
    _qepIdx = i;
    var s = series[i];
    document.getElementById('qep-title').innerHTML = s.name + ' ‚Äî <span>' + s.prefix + ' ' + String(s.nextEp).padStart(2,'0') + '</span>';
    document.getElementById('qep-info').textContent = 'T√≠tulo: "' + (s.titleTemplate||s.name) + '"';
    document.getElementById('qep-link').value = '';
    clearImg('qep-img','qep-img-prev','qep-img-file');
    if(document.getElementById('qep-grade')){document.getElementById('qep-grade').value='true';setEpGrade(true);}
    openModal('quick-ep-modal');
    setTimeout(function(){ document.getElementById('qep-link').focus(); }, 200);
  }

  function setEpGrade(val) {
    document.getElementById('qep-grade').value = val ? 'true' : 'false';
    var sim = document.getElementById('qep-opt-sim');
    var nao = document.getElementById('qep-opt-nao');
    if (sim) {
      sim.style.border     = val ? '1px solid rgba(29,185,84,.5)' : '1px solid rgba(168,184,204,.12)';
      sim.style.background = val ? 'rgba(29,185,84,.08)' : 'transparent';
      sim.querySelector('div').style.color = val ? '#1db954' : 'var(--silver)';
    }
    if (nao) {
      nao.style.border     = !val ? '1px solid rgba(192,21,42,.5)' : '1px solid rgba(168,184,204,.12)';
      nao.style.background = !val ? 'rgba(192,21,42,.08)' : 'transparent';
      nao.querySelector('div').style.color = !val ? 'var(--red-glow)' : 'var(--silver)';
    }
  }

  function submitQuickEp() {
    var link   = document.getElementById('qep-link').value.trim();
    if (!link) { toast('‚ö† Cole o link do v√≠deo!'); return; }
    var s      = series[_qepIdx];
    var season = parseInt(document.getElementById('qep-season').value) || 1;
    var epLabel= s.prefix + ' ' + String(s.nextEp).padStart(2,'0');
    var img    = document.getElementById('qep-img').value.trim() || s.defaultImg || '';
    var gradeOnly = document.getElementById('qep-grade') ? document.getElementById('qep-grade').value !== 'false' : true;
    videos.unshift({ title: s.titleTemplate||s.name, ep: epLabel, link: link, img: img, season: season, seriesIdx: _qepIdx, gradeOnly: gradeOnly });
    saveVideos();
    s.nextEp++;
    s.lastUpdated = Date.now();
    saveSeries_();
    closeModal('quick-ep-modal');
    renderSeriesGrid();
    renderDashboard();
    toast('‚úÖ ' + epLabel + ' adicionado!');
  }

  /* ===== CONFIG ===== */
  function changePass() {
    var cur  = document.getElementById('cur-pass').value;
    var novo = document.getElementById('new-pass').value;
    var conf = document.getElementById('confirm-pass').value;
    if (cur !== getPass()) { toast('‚ùå Senha atual incorreta!'); return; }
    if (!novo) { toast('‚ö† Digite a nova senha!'); return; }
    if (novo !== conf) { toast('‚ö† Senhas n√£o coincidem!'); return; }
    localStorage.setItem(PASS_KEY, novo);
    ['cur-pass','new-pass','confirm-pass'].forEach(function(id){ document.getElementById(id).value=''; });
    toast('‚úÖ Senha alterada!');
  }

  function clearAll() {
    if (!confirm('Apagar TODOS os v√≠deos? Irrevers√≠vel.')) return;
    videos = []; saveVideos(); renderDashboard();
    toast('üóë Todos os v√≠deos removidos.');
  }

  function clearAllSeries() {
    if (!confirm('Apagar TODAS as s√©ries? Os v√≠deos permanecem. Irrevers√≠vel.')) return;
    series = []; saveSeries_(); renderSeriesGrid(); renderDashboard();
    toast('üóë Todas as s√©ries removidas.');
  }


  /* ===== BACKUP / RESTORE ===== */
  var _pendingImport = null;

  function exportBackup() {
    var data = {
      version: 1,
      exported: new Date().toISOString(),
      siteName: 'M√°scara Secreta',
      videos: videos,
      series: series
    };
    var json = JSON.stringify(data, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    var date = new Date().toISOString().slice(0,10);
    a.href     = url;
    a.download = 'mascara-secreta-backup-' + date + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('‚úÖ Backup exportado!');
  }

  function importBackup(input) {
    var file = input.files[0];
    if (!file) return;
    document.getElementById('import-filename').textContent = file.name;
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        // Validate structure
        if (!Array.isArray(data.videos) || !Array.isArray(data.series)) {
          toast('‚ùå Arquivo inv√°lido! Verifique se √© um backup correto.');
          return;
        }
        _pendingImport = data;
        var vCount = data.videos.length;
        var sCount = data.series.length;
        var exported = data.exported ? new Date(data.exported).toLocaleString('pt-BR') : 'data desconhecida';
        document.getElementById('import-preview-text').innerHTML =
          '<b>' + vCount + '</b> v√≠deo' + (vCount!==1?'s':'') + ' ¬∑ '
          + '<b>' + sCount + '</b> s√©rie' + (sCount!==1?'s':'')
          + '<br><span style="font-size:.78rem;opacity:.6">Exportado em: ' + exported + '</span>';
        document.getElementById('import-preview').style.display = 'block';
      } catch(err) {
        toast('‚ùå Erro ao ler arquivo JSON!');
        _pendingImport = null;
      }
    };
    reader.readAsText(file);
  }

  function confirmImport() {
    if (!_pendingImport) return;
    if (!confirm('Substituir os dados atuais pelo backup? Esta a√ß√£o n√£o pode ser desfeita.')) return;
    videos = _pendingImport.videos;
    series = _pendingImport.series;
    saveVideos();
    saveSeries_();
    _pendingImport = null;
    cancelImport();
    renderDashboard();
    toast('‚úÖ Backup importado com sucesso!');
    showSection('dashboard');
  }

  function cancelImport() {
    _pendingImport = null;
    document.getElementById('import-preview').style.display = 'none';
    document.getElementById('import-filename').textContent = '';
    document.getElementById('import-file').value = '';
  }

  function confirmLogout() {
    if (confirm('Sair do admin?')) { sessionStorage.removeItem('ms_admin_auth'); window.location.href='index.html'; }
  }

  /* ===== FECHA MODAL AO CLICAR FORA ===== */
  document.querySelectorAll('.modal-overlay').forEach(function(o){
    o.addEventListener('click', function(e){
      if (e.target === o) {
        if (o.id === 'preview-modal') closePreview();
        else closeModal(o.id);
      }
    });
  });

  /* ===== DATE ===== */
  document.getElementById('topbar-date').textContent = new Date().toLocaleDateString('pt-BR', {weekday:'short',day:'2-digit',month:'short',year:'numeric'});

  /* ===== INIT ===== */
  renderDashboard();
</script>
</body>
</html>
